/*!
 * EventEmitter v4.2.7 - git.io/ee
 * Oliver Caldwell
 * MIT license
 * @preserve
 */

(function(){function e(){}function t(e,t){for(var r=e.length;r--;)if(e[r].listener===t)return r;return-1}function r(e){return function(){return this[e].apply(this,arguments)}}var s=e.prototype,n=this,a=n.EventEmitter;s.getListeners=function(e){var t,r,s=this._getEvents();if(e instanceof RegExp){t={};for(r in s)s.hasOwnProperty(r)&&e.test(r)&&(t[r]=s[r])}else t=s[e]||(s[e]=[]);return t},s.flattenListeners=function(e){var t,r=[];for(t=0;t<e.length;t+=1)r.push(e[t].listener);return r},s.getListenersAsObject=function(e){var t,r=this.getListeners(e);return r instanceof Array&&(t={},t[e]=r),t||r},s.addListener=function(e,r){var s,n=this.getListenersAsObject(e),a="object"==typeof r;for(s in n)n.hasOwnProperty(s)&&-1===t(n[s],r)&&n[s].push(a?r:{listener:r,once:!1});return this},s.on=r("addListener"),s.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},s.once=r("addOnceListener"),s.defineEvent=function(e){return this.getListeners(e),this},s.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},s.removeListener=function(e,r){var s,n,a=this.getListenersAsObject(e);for(n in a)a.hasOwnProperty(n)&&(s=t(a[n],r),-1!==s&&a[n].splice(s,1));return this},s.off=r("removeListener"),s.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},s.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},s.manipulateListeners=function(e,t,r){var s,n,a=e?this.removeListener:this.addListener,i=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(s=r.length;s--;)a.call(this,t,r[s]);else for(s in t)t.hasOwnProperty(s)&&(n=t[s])&&("function"==typeof n?a.call(this,s,n):i.call(this,s,n));return this},s.removeEvent=function(e){var t,r=typeof e,s=this._getEvents();if("string"===r)delete s[e];else if(e instanceof RegExp)for(t in s)s.hasOwnProperty(t)&&e.test(t)&&delete s[t];else delete this._events;return this},s.removeAllListeners=r("removeEvent"),s.emitEvent=function(e,t){var r,s,n,a,i=this.getListenersAsObject(e);for(n in i)if(i.hasOwnProperty(n))for(s=i[n].length;s--;)r=i[n][s],r.once===!0&&this.removeListener(e,r.listener),a=r.listener.apply(this,t||[]),a===this._getOnceReturnValue()&&this.removeListener(e,r.listener);return this},s.trigger=r("emitEvent"),s.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},s.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},s._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},s._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return n.EventEmitter=a,e},"function"==typeof define&&define.amd?define("eventEmitter/EventEmitter",[],function(){return e}):"object"==typeof module&&module.exports?module.exports=e:this.EventEmitter=e}).call(this),function(){var e={serialize:function(e,r,s){s=s||{};var n=s.encode||t,a=[e+"="+n(r)];if(null!=s.maxAge){var i=s.maxAge-0;if(isNaN(i))throw new Error("maxAge should be a Number");a.push("Max-Age="+i)}return s.domain&&a.push("Domain="+s.domain),s.path&&a.push("Path="+s.path),s.expires&&a.push("Expires="+s.expires.toUTCString()),s.httpOnly&&a.push("HttpOnly"),s.secure&&a.push("Secure"),a.join("; ")},parse:function(e,t){t=t||{};var s={},n=e.split(/; */),a=t.decode||r;return n.forEach(function(e){var t=e.indexOf("=");if(!(0>t)){var r=e.substr(0,t).trim(),n=e.substr(++t,e.length).trim();if('"'==n[0]&&(n=n.slice(1,-1)),void 0==s[r])try{s[r]=a(n)}catch(i){s[r]=n}}}),s}},t=encodeURIComponent,r=decodeURIComponent;"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define("cookie-js/cookie",[],function(){return e}):window.cookiejs=e}.call(this),function(e){function t(t,s){return function(n){e.localStorage||console.error("Local storage must be supported for instant login.");var a=this,i={domain:location.hostname.split(".").slice(-2).join("."),path:"/",secure:"https:"===location.protocol,expires:new Date(Date.now()+6048e5)},o=/ref=(\w+)/.exec(e.location.search),l=s.parse(document.cookie).webmakerReferral;o&&(o=o[1]),n=n||{},n.paths=n.paths||{},a.emitter=new t,a.host=n.host||"",a.paths=n.paths||{},a.paths.authenticate=n.paths.authenticate||"/authenticate",a.paths.create=n.paths.create||"/create",a.paths.verify=n.paths.verify||"/verify",a.paths.logout=n.paths.logout||"/logout",a.paths.checkUsername=n.paths.checkUsername||"/check-username",a.urls={authenticate:a.host+a.paths.authenticate,create:a.host+a.paths.create,verify:a.host+a.paths.verify,logout:a.host+a.paths.logout,checkUsername:a.host+a.paths.checkUsername},a.audience=n.audience||e.location.protocol+"//"+e.location.host,a.prefix=n.prefix||"webmaker-",a.timeout=n.timeout||10,a.localStorageKey=a.prefix+"login",a.csrfToken=n.csrfToken,a.withCredentials=n.withCredentials===!1?!1:!0,o&&l!==o&&(document.cookie=s.serialize("webmakerReferral",o,i)),a.handleNewUserUI=n.handleNewUserUI===!1?!1:!0,a.modal={},a.modal.element=document.getElementById("webmaker-login-new-user"),a.modal.dismissSelector="[data-dismiss]",a.modal.createSelector=".create-user",a.modal.createBtnOnClick=function(){},a.modal.checkUsernameOnChange=function(){var e=a.modal.element.querySelector(".username-taken-error"),t=a.modal.element.querySelector(".username-invalid-error"),r=a.modal.element.querySelector(".username-required-error"),s=a.modal.element.querySelector(".username-group"),n=this.value;return n?void a.checkUsername(n,function(n,a){n&&"Username taken"===a?(s.classList.add("has-error"),s.classList.remove("has-success"),e.classList.remove("hidden"),r.classList.add("hidden"),t.classList.add("hidden")):n&&"Username invalid"===a?(s.classList.add("has-error"),s.classList.remove("has-success"),t.classList.remove("hidden"),e.classList.add("hidden"),r.classList.add("hidden")):(s.classList.remove("has-error"),s.classList.add("has-success"),e.classList.add("hidden"),r.classList.add("hidden"),t.classList.add("hidden"))}):(s.classList.remove("has-success"),s.classList.add("has-error"),e.classList.add("hidden"),r.classList.remove("hidden"),void t.classList.add("hidden"))},a.modal.setup=function(e){var t=a.modal.element.querySelector(a.modal.createSelector),r=a.modal.element.querySelectorAll(a.modal.dismissSelector),s=a.modal.element.querySelector(".username-group"),n=a.modal.element.querySelector(".agree-group"),i=a.modal.element.querySelector(".username-taken-error"),o=a.modal.element.querySelector(".username-required-error"),c=a.modal.element.querySelector(".username-invalid-error"),d=a.modal.element.querySelector(".agree-error"),u=a.modal.element.querySelector('[name="username"]'),m=a.modal.element.querySelector('[name="agreeToTerms"]'),h=a.modal.element.querySelector('[name="mailingList"]');t.removeEventListener("click",a.modal.createBtnOnClick,!1),u.addEventListener("change",a.modal.checkUsernameOnChange,!1),a.modal.createBtnOnClick=function(){var t=!1;m.checked||(n.classList.add("has-error"),d.classList.remove("hidden"),t=!0),u.value||(s.classList.remove("has-success"),s.classList.add("has-error"),i.classList.add("hidden"),o.classList.remove("hidden"),c.classList.add("hidden"),t=!0),t||a.checkUsername(u.value,function(t,r){t&&"Username taken"===r?(s.classList.add("has-error"),s.classList.remove("has-success"),i.classList.remove("hidden"),o.classList.add("hidden"),c.classList.add("hidden")):t&&"Username invalid"===r?(s.classList.add("has-error"),s.classList.remove("has-success"),c.classList.remove("hidden"),i.classList.add("hidden"),o.classList.add("hidden")):(a.createUser({assertion:e,user:{username:u.value,mailingList:h.checked,referrer:l}}),i.classList.add("hidden"),o.classList.add("hidden"),c.classList.add("hidden"),d.classList.add("hidden"),s.classList.remove("has-error"),s.classList.remove("has-success"),n.classList.remove("has-error"),a.modal.close())})};for(var f=0;f<r.length;f++)r[f].removeEventListener("click",a.modal.close,!1),r[f].addEventListener("click",a.modal.close,!1);t.addEventListener("click",a.modal.createBtnOnClick,!1)},a.modal.open=function(){a.modal.element.classList.add("in"),a.modal.element.style.display="block",a.modal.element.setAttribute("aria-hidden",!1)},a.modal.close=function(){a.modal.element.classList.remove("in"),a.modal.element.style.display="none",a.modal.element.setAttribute("aria-hidden",!0)},a.on=function(e,t){a.emitter.addListener(e,t)},a.off=function(e,t){a.emitter.removeListener(e,t)},a.checkUsername=function(e,t){if(!r.test(e))return t(!0,"Username invalid");var s=new XMLHttpRequest,n=JSON.stringify({username:e});s.open("POST",a.urls.checkUsername,!0),s.withCredentials=a.withCredentials,s.setRequestHeader("Content-type","application/json"),s.setRequestHeader("X-CSRF-Token",a.csrfToken),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){var e=JSON.parse(s.responseText);e.exists?t(!0,"Username taken"):t(!1,"Username not taken")}else 4===s.readyState&&s.status&&(s.status>=400||s.status<200)?(a.emitter.emitEvent("error",[s.responseText]),t(!1,"Error checking username")):4===s.readyState&&(a.emitter.emitEvent("error",["Looks like "+a.urls.checkUsername+" is not responding..."]),t(!1,"Error checking username"))},s.send(n)},a.createUser=function(e){var t=new XMLHttpRequest,r=JSON.stringify({assertion:e.assertion,audience:a.audience,user:e.user});t.open("POST",a.urls.create,!0),t.withCredentials=a.withCredentials,t.setRequestHeader("Content-type","application/json"),t.setRequestHeader("X-CSRF-Token",a.csrfToken),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var e=JSON.parse(t.responseText);e.user?(a.storage.set(e.user),a.emitter.emitEvent("login",[e.user,"user created"])):a.emitter.emitEvent("error",[t.responseText])}else 4===t.readyState&&t.status&&(t.status>=400||t.status<200)?a.emitter.emitEvent("error",[t.responseText]):4===t.readyState&&a.emitter.emitEvent("error",["Looks like "+a.urls.create+" is not responding..."])},t.send(r)},a.verify=function(){a.storage.get()&&a.emitter.emitEvent("login",[a.storage.get(),"restored"]);var e=a.storage.get("email"),t=new XMLHttpRequest;t.open("POST",a.urls.verify,!0),t.withCredentials=a.withCredentials,t.setRequestHeader("Content-type","application/json"),t.setRequestHeader("X-CSRF-Token",a.csrfToken),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var r=JSON.parse(t.responseText);e&&r.email===e?(a.emitter.emitEvent("login",[r.user]),a.storage.set(r.user)):r.user?(a.emitter.emitEvent("login",[r.user,"email mismatch"]),a.storage.set(r.user)):a.logout()}else 4===t.readyState&&t.status&&(t.status>=400||t.status<200)?a.emitter.emitEvent("error",[t.responseText]):4===t.readyState&&a.emitter.emitEvent("error",["Looks like "+a.urls.verify+" is not responding..."])},t.send()},a.login=function(){e.navigator.id||console.error("No persona found. Did you include include.js?"),e.removeEventListener("focus",a.verify,!1),e.navigator.id.get(function(t){if(!t)return void a.emitter.emitEvent("error",["No assertion was received"]);var r=new XMLHttpRequest,s=JSON.stringify({audience:a.audience,assertion:t});if(a.timeout)var n=setTimeout(function(){a.emitter.emitEvent("error",["The request for a token timed out after "+a.timeout+" seconds"])},1e3*a.timeout);r.open("POST",a.urls.authenticate,!0),r.withCredentials=a.withCredentials,r.setRequestHeader("Content-type","application/json"),r.setRequestHeader("X-CSRF-Token",a.csrfToken),r.onreadystatechange=function(){if(a.timeout&&n&&clearTimeout(n),4===r.readyState&&200===r.status){var s=JSON.parse(r.responseText);s.error&&a.emitter.emitEvent("error",[s.error]),s.user&&(a.storage.set(s.user),a.emitter.emitEvent("login",[s.user]),e.addEventListener("focus",a.verify,!1)),s.email&&!s.user&&(a.emitter.emitEvent("newuser",[t,s.email]),a.handleNewUserUI&&(a.modal.setup(t,s.email),a.modal.open())),s.err&&a.emitter.emitEvent("error",[s.err])}else 4===r.readyState&&r.status&&(r.status>=400||r.status<200)?a.emitter.emitEvent("error",[r.responseText]):4===r.readyState&&a.emitter.emitEvent("error",["Looks like "+a.urls.authenticate+" is not responding..."])},r.send(s)},{backgroundColor:"#E3EAEE",privacyPolicy:"https://webmaker.org/privacy",siteLogo:"https://stuff.webmaker.org/persona-assets/logo-webmaker.png",siteName:"Mozilla Webmaker",termsOfService:"https://webmaker.org/terms"})},a.logout=function(){e.removeEventListener("focus",a.verify,!1);var t=new XMLHttpRequest;t.open("POST",a.urls.logout,!0),t.withCredentials=a.withCredentials,t.setRequestHeader("X-CSRF-Token",a.csrfToken),t.onreadystatechange=function(){4===t.readyState&&200===t.status?(a.emitter.emitEvent("logout"),a.storage.clear(),e.addEventListener("focus",a.verify,!1)):4===t.readyState&&t.status&&(t.status>=400||t.status<200)?a.emitter.emitEvent("error",[t.responseText]):4===t.readyState&&a.emitter.emitEvent("error",["Looks like "+a.urls.logout+" is not responding..."])},t.send(null)},a.storage={get:function(e){var t=JSON.parse(localStorage.getItem(a.localStorageKey));if(t)return e?t[e]:t},set:function(e){var t=JSON.parse(localStorage.getItem(a.localStorageKey))||{};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);localStorage.setItem(a.localStorageKey,JSON.stringify(t))},clear:function(){delete localStorage[a.localStorageKey]}}}}var r=/^[abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\-\_]{1,20}$/;"function"==typeof define&&define.amd?define("webmaker-auth-client",["eventEmitter/EventEmitter","cookie-js/cookie"],t):e.WebmakerAuthClient=t(e.EventEmitter,e.cookiejs)}(window);